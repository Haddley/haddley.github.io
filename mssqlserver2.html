<!DOCTYPE html>
<html  >
<head>
  
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
  <link rel="shortcut icon" href="assets/images/15018162-128x128.png" type="image/x-icon">
  <meta name="description" content="">
  
  
  <title>Microsoft SQL Server (Part 2)</title>
  <link rel="stylesheet" href="assets/web/assets/mobirise-icons2/mobirise2.css">
  <link rel="stylesheet" href="assets/web/assets/mobirise-icons-bold/mobirise-icons-bold.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="assets/dropdown/css/style.css">
  <link rel="stylesheet" href="assets/socicon/css/styles.css">
  <link rel="stylesheet" href="assets/theme/css/style.css">
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Jost:100,200,300,400,500,600,700,800,900,100i,200i,300i,400i,500i,600i,700i,800i,900i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Jost:100,200,300,400,500,600,700,800,900,100i,200i,300i,400i,500i,600i,700i,800i,900i&display=swap"></noscript>
  <link rel="preload" as="style" href="assets/mobirise/css/mbr-additional.css?v=kFxB16"><link rel="stylesheet" href="assets/mobirise/css/mbr-additional.css?v=kFxB16" type="text/css">

  
  <link href="prism.css" rel="stylesheet" />
<!-- include A-Frame obviously -->
<script src="aframe.min.js"></script>
<!-- include ar.js for A-Frame -->
<script src="aframe-ar.js"></script>



  
</head>
<body>
  
  <section data-bs-version="5.1" class="menu menu3 cid-srHJ1d47l6" once="menu" id="menu3-lm">
    
    <nav class="navbar navbar-dropdown navbar-fixed-top navbar-expand-lg">
        <div class="container">
            <div class="navbar-brand">
                
                <span class="navbar-caption-wrap"><a class="navbar-caption text-black text-primary display-7" href="index.html">Neil Haddley</a></span>
            </div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbarSupportedContent" data-bs-target="#navbarSupportedContent" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav nav-dropdown nav-right" data-app-modern-menu="true"><li class="nav-item"><a class="nav-link link text-black text-primary display-4" href="posts.html">
                            Blog Posts</a></li></ul>
                <div class="icons-menu">
                    <a class="iconfont-wrapper" href="https://www.linkedin.com/in/neil-haddley/" target="_blank">
                        <span class="p-2 mbr-iconfont socicon-linkedin socicon"></span>
                    </a>
                    <a class="iconfont-wrapper" href="https://github.com/haddley" target="_blank">
                        <span class="p-2 mbr-iconfont mbrib-github"></span>
                    </a>
                    <a class="iconfont-wrapper" href="https://www.npmjs.com/~haddley" target="_blank">
                        <span class="p-2 mbr-iconfont socicon-npm socicon"></span>
                    </a>
                    <a class="iconfont-wrapper" href="https://hub.docker.com/u/haddley" target="_blank">
                        <span class="p-2 mbr-iconfont mobi-mbri-delivery mobi-mbri"></span>
                    </a>
                </div>
                
            </div>
        </div>
    </nav>
</section>

<section data-bs-version="5.1" class="content4 cid-srHJ1duEbC" id="content4-ln">
    
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="title col-md-12 col-lg-10">
                <h3 class="mbr-section-title mbr-fonts-style align-center mb-4 display-2">
                    <strong>Microsoft SQL Server (Part 2)</strong></h3>
                <h4 class="mbr-section-subtitle align-center mbr-fonts-style mb-4 display-5">T-SQL, Stored Procedures and Snapshot Isolation.</h4>
                
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image3 cid-srHJ1dEuag" id="image3-lo">
    

    

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="image-wrapper">
                    <a href="mssqlserver.html"><img src="assets/images/ads.svg" alt=""></a>
                    <p class="mbr-description mbr-fonts-style mt-2 align-center display-4"><a href="https://github.com/microsoft/azuredatastudio/blob/main/extensions/sql-migration/media/ads.svg" class="text-primary">ads</a>&nbsp;by&nbsp;<a href="https://www.microsoft.com" class="text-primary">Microsoft Corporation</a>&nbsp;is licensed under&nbsp;<a rel="nofollow" class="external text" href="https://github.com/microsoft/azuredatastudio/blob/main/LICENSE.txt">Source EULA</a></p>
                </div>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-srHOLrZ2Vo" id="content5-m2">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Stored procedures</h4>
                <p class="mbr-text mbr-fonts-style display-7">Transact SQL (T-SQL) statements are used to create Microsoft SQL Server Stored Procedures.<br><br>Stored Procedures are maintained in the database making it easier to apply updates that improve the performance of all client applications.<br><br>Stored Procedures that help customers to purchase cinema tickets or reserve seats on airplanes need to be written with isolation levels in mind.</p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssQexQabMk" id="content5-mi">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Shuffling cards</h4>
                <p class="mbr-text mbr-fonts-style display-7">Consider how a stored procedure might be used to shuffle the contents of a table representing a deck of playing cards.&nbsp;<br></p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-srHPMoM3g0" id="content7-m3">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>Using cross join to create a table the represents a standard deck of playing cards</strong></h5>

<pre class="language-clike"><code><!--         
-- Create the Deck
CREATE TABLE Cards
(
    Card CHAR(5) PRIMARY KEY
)
GO

INSERT INTO Cards
VALUES
    ('Ace'),
    ('2'),
    ('3'),
    ('4'),
    ('5'),
    ('6'),
    ('7'),
    ('8'),
    ('9'),
    ('10'),
    ('Jack'),
    ('Queen'),
    ('King')
GO

CREATE TABLE Suits
(
    Suit CHAR(8) PRIMARY KEY
)
GO

INSERT INTO Suits
VALUES
    ('Clubs'),
    ('Diamonds'),
    ('Hearts'),
    ('Spades')
GO

SELECT Id = IDENTITY(INT, 1, 1),
    Suits.Suit,
    Cards.Card
INTO Deck
FROM Cards
CROSS JOIN Suits
GO

ALTER TABLE Deck ADD CONSTRAINT Deck_PK PRIMARY KEY (Id)
GO
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-srHZtoAkBD" id="content5-m4">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Swap cards</h4>
                <p class="mbr-text mbr-fonts-style display-7">To shuffle a deck of standard playing cards we could select any two cards from the deck at random and swap their positions. If we did this enough times the deck would be shuffled.<br><br>Here is a stored procedure that will swap the data in two rows of the deck table.</p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-srI09aA9Jh" id="content7-m5">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>SwapCardsV1</strong></h5>

<pre class="language-clike"><code><!--         
-- Stored Procedure 'SwapCardsV1'
CREATE PROCEDURE SwapCardsV1
    @Card1 INT = 1,
    @Card2 INT = 52
AS
BEGIN
    
    BEGIN TRY
		BEGIN TRANSACTION

		SET NOCOUNT ON

		-- Store the first card's details
		SELECT *
        INTO #Temp
        FROM Deck
        WHERE Id = @Card1

		-- Move second card into first card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT d.Card,
            d.Suit
        FROM Deck d
        WHERE Id = @Card2
			) CardDetails
		WHERE Id = @Card1

		-- Move first card into second card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT Card,
            Suit
        FROM #temp
			) CardDetails
		WHERE Id = @Card2

		COMMIT TRANSACTION;
	END TRY

	BEGIN CATCH
		-- PRINT 'We were unable to make the swap rolling back [' + ERROR_MESSAGE() + '].';
		ROLLBACK TRANSACTION;
        THROW 51000, 'Unable to swap card.', 1; 
	END CATCH
END
GO
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-srI4do1BfL" id="content5-m6">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Pick two cards, swap and repeat</h4>
                <p class="mbr-text mbr-fonts-style display-7">To test the SwapCards stored procedure we can create:<br></p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content9 cid-ssQAaTOhlb" id="content9-mv">
    

    <div class="container">
        <div class="row justify-content-center">
            <div class="counter-container col-md-12 col-lg-10">
                
                <div class="mbr-text mbr-fonts-style display-7">
                    <ol>
                        <li><strong>a PickACard function </strong>that selects a card from the deck at random</li>
                        <li><strong>a SwapCardsAtRandom stored procedure </strong>that uses the PickACard function (twice) and the SwapCards stored procedure (above) to swap the random pair of cards; <strong>and</strong></li>
                        <li><strong>client code </strong>that calls the SwapCardsAtRandom stored procedure 1,000 times.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-ssQk6k6Pcc" id="content7-mj">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>SwapCards T-SQL Client Code</strong></h5>

<pre class="language-clike"><code><!--         
-- User Defined Function 'PickACard'
CREATE FUNCTION PickACard (@RAND FLOAT)
RETURNS INT
AS
BEGIN
    RETURN (
			SELECT FLOOR(@RAND * (52 - 1 + 1)) + 1
			)
END
GO

-- Stored Procedure 'SwapCardsAtRandom'
CREATE PROCEDURE SwapCardsAtRandom
AS
BEGIN
    DECLARE @Rnd1 FLOAT

    SET @Rnd1 = RAND()

    DECLARE @Card1 INT

    SET @Card1 = (
			SELECT dbo.PickACard(@Rnd1)
			)

    DECLARE @Rnd2 FLOAT

    SET @Rnd2 = RAND()

    DECLARE @Card2 INT

    SET @Card2 = (
			SELECT dbo.PickACard(@Rnd2)
			)

    -- 'No need to swap a card with itself'
    IF @Card1 != @Card2
	BEGIN
        EXECUTE dbo.SwapCardsV1 @Card1,
			@Card2
    END -- IF @Card1 != @Card2
END -- CREATE PROCEDURE SwapCards
GO

-- Call Swap Cards Multiple times
DECLARE @Counter INT
SET @Counter = 0
DECLARE @ErrorCounter INT
SET @ErrorCounter = 0
WHILE (@Counter < 1000)
BEGIN

    BEGIN TRY
		EXECUTE SwapCardsAtRandom
	END TRY

	BEGIN CATCH
		SET @ErrorCounter = @ErrorCounter+1
        PRINT 'We were unable to swap cards [' + ERROR_MESSAGE() +']. Error Count ['+LTRIM(STR(@ErrorCounter,10))+']'  
	END CATCH
    
    SET @Counter = @Counter + 1
END
GO

-- Review results
SELECT COUNT(*)
FROM Deck
GROUP BY Suit
GO

SELECT *
FROM Deck
ORDER BY Card,Suit
GO
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssQlaJj3lY" id="content5-mk">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">With a single client</h4>
                <p class="mbr-text mbr-fonts-style display-7">Running a single copy of client code that calls the SwapCardV1 stored procedure is fine.<br><br>The result is a shuffled deck with 13 cards of each suit.</p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image3 cid-ssQmWvcG4M" id="image3-ml">
    

    

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="image-wrapper">
                    <img src="assets/images/screen-shot-2021-03-27-at-9.01.56-pm-1836x1139.png" alt="">
                    <p class="mbr-description mbr-fonts-style mt-2 align-center display-4">Shuffle results single client</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssQn9RDZNp" id="content5-mm">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Concurrency issues</h4>
                <p class="mbr-text mbr-fonts-style display-7">However, running multiple copies of the client code that calls the SwapCardV1 stored procedure reveals an issue.<br></p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image3 cid-ssQoBykktN" id="image3-mn">
    

    

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="image-wrapper">
                    <img src="assets/images/screen-shot-2021-03-27-at-9.08.55-pm-1836x1136.png" alt="">
                    <p class="mbr-description mbr-fonts-style mt-2 align-center display-4">Shuffle failure</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssQoPziyiI" id="content5-mo">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Snapshot issolation</h4>
                <p class="mbr-text mbr-fonts-style display-7">When concurrency is introduced our original SwapCards stored procedure does not work. No errors are being raised but transactions are stepping on each other.<br><br>We can use Snapshot isolation to address the issue.</p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-ssQq1YsQtI" id="content7-mp">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>SwapCards (with snapshot isolation)</strong></h5>

<pre class="language-clike"><code><!--         
-- Stored Procedure 'SwapCards'
CREATE PROCEDURE SwapCards
    @Card1 INT = 1,
    @Card2 INT = 52
AS
BEGIN
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;

    BEGIN TRY
		BEGIN TRANSACTION

		SET NOCOUNT ON

		-- Store the first card's details
		SELECT *
        INTO #Temp
        FROM Deck
        WHERE Id = @Card1

		-- Move second card into first card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT d.Card,
            d.Suit
        FROM Deck d
        WHERE Id = @Card2
			) CardDetails
		WHERE Id = @Card1

		-- Move first card into second card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT Card,
            Suit
        FROM #temp
			) CardDetails
		WHERE Id = @Card2

		COMMIT TRANSACTION;
	END TRY

	BEGIN CATCH
		-- PRINT 'We were unable to make the swap rolling back [' + ERROR_MESSAGE() + '].';
		ROLLBACK TRANSACTION;
        THROW 51000, 'Unable to swap card.', 1; 
	END CATCH
END
GO
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssQrvJ8BlW" id="content5-mq">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Multiple clients</h4>
                <p class="mbr-text mbr-fonts-style display-7">With the updated SwapCard stored procedure we can run multiple updates concurrently.</p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image3 cid-ssQs2WnUYl" id="image3-mr">
    

    

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="image-wrapper">
                    <img src="assets/images/screen-shot-2021-03-27-at-9.25.19-pm-1836x1138.png" alt="">
                    <p class="mbr-description mbr-fonts-style mt-2 align-center display-4">Shuffle success</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-st7mvYZyfz" id="content5-ou">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Catching the errors</h4>
                <p class="mbr-text mbr-fonts-style display-7">Snapshot isolation guarantees that reads made in a transaction will see a consistent snapshot of the database and that the transaction will commit only if no update made in the transaction conflicts with another concurrent update.<br><br>With snapshot isolation enabled there is a chance that a commit will fail and that an error will be raised. This is a good thing.<br><br>In the code shown above if SwapCards throws an error the client code catches the error, prints a message and continues. Perhaps instead the client code should retry the swap?</p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="image3 cid-ssQsLOqUlo" id="image3-mt">
    

    

    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="image-wrapper">
                    <img src="assets/images/screen-shot-2021-03-27-at-9.25.30-pm-1836x1131.png" alt="">
                    <p class="mbr-description mbr-fonts-style mt-2 align-center display-4">Concurrency exceptions (that the client code needs to handle)</p>
                </div>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssWb9q5azA" id="content5-mz">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">.NET Core console app</h4>
                <p class="mbr-text mbr-fonts-style display-7"><strong>$ dotnet run</strong><br><br>The code below calls the SwapCards stored procedure 1000 times using C#.<strong><br></strong></p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-ssVYTBvtWG" id="content7-mx">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>Program.cs</strong></h5>

<pre class="language-clike"><code><!--         
using System;
using System.Data.SqlClient;
using System.Data;

namespace dotnet_sql {
  class Program {
    static void Main(string[] args) {
      var cs = @ "User ID=sa;Password=Passw0rd123;Initial Catalog=Shuffle;Server=192.168.68.109;";

      using var con = new SqlConnection(cs);
      con.Open();

      using(SqlCommand cmd = new SqlCommand("dbo.SwapCards", con)) {
        cmd.CommandType = CommandType.StoredProcedure;
        cmd.Parameters.Add("@Card1", SqlDbType.Int);
        cmd.Parameters.Add("@Card2", SqlDbType.Int);

        int errorCounter = 0;
        for (int count = 0; count < 1000; count++) {
          Random rn = new Random();
          int card1 = rn.Next(1, 52);
          int card2 = rn.Next(1, 52);

          cmd.Parameters["@Card1"].Value = card1;
          cmd.Parameters["@Card2"].Value = card2;

          try {
            cmd.ExecuteNonQuery();
          } catch (Exception e) {
            errorCounter++;
            Console.WriteLine("We were unable to swap cards [" + e.Message + "]. Error Count [" +
              errorCounter + "]");
          }

        }
      }
    }
  }
}
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssWbag9Q3v" id="content5-n0">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Node console app</h4>
                <p class="mbr-text mbr-fonts-style display-7"><strong>$ node index.js</strong><br><br>The code below calls the SwapCards stored procedure 1000 times using JavaScript and the 'mssql' node module.<strong><br></strong></p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-ssWaykNTIe" id="content7-my">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>index.js</strong></h5>

<pre class="language-clike"><code><!--         
const mssql = require('mssql')

const config = {
    user: 'sa',
    password: 'Passw0rd123',
    server: '192.168.68.109',
    database: 'Shuffle',
    options: { enableArithAbort: false }
};

const dbConn = mssql.connect(config, function (err) {

    if (err) {
        console.log(err);
        return
    }

    const request = new mssql.Request();

    request.input('Card1', mssql.Int);
    request.input('Card2', mssql.Int);

    let errorCounter = 0;

    (async () => {
        for (x = 0; x < 1000; x++) {

            const card1 = Math.floor(Math.random() * (52 - 1 + 1)) + 1
            const card2 = Math.floor(Math.random() * (52 - 1 + 1)) + 1

            request.parameters.Card1.value = card1;
            request.parameters.Card2.value = card2;

            if (card1 != card2) {

                try {
                    await request.execute('dbo.SwapCards')
                } catch (e) {
                    errorCounter++;
                    console.error("We were unable to swap cards [" + e.originalError.message + "]. Error Count [" + errorCounter + "]");
                }

            }
        }
        dbConn.close();

    })().catch(err => {
        console.error(err);
    });

})
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content5 cid-ssWbb6iFYs" id="content5-n1">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-12 col-lg-10">
                
                <h4 class="mbr-section-subtitle mbr-fonts-style mb-4 display-5">Java console app</h4>
                <p class="mbr-text mbr-fonts-style display-7"><strong>$ javac Program.java</strong><br><br>then<br><br><strong>$ java -cp ".:/Users/neilhaddley/sqljdbc_9.2/enu/mssql-jdbc-9.2.1.jre11.jar" Program</strong><br><br>or<br><br><strong>$ export CLASSPATH=.:/Users/neilhaddley/sqljdbc_9.2/enu/mssql-jdbc-9.2.1.jre11.jar</strong><br><br><strong>$ java Program</strong><br><br>The code below calls the&nbsp;SwapCards stored procedure 1000 times using Java.<br></p>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-ssVQARHGmI" id="content7-mw">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>Program.java</strong></h5>

<pre class="language-clike"><code><!--         
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.SQLException;
import java.sql.CallableStatement;
import java.util.Random;

public class Program {


    public static void main(String[] args) {

        String connectionUrl = "jdbc:sqlserver://192.168.68.109:1433;databaseName=Shuffle;user=sa;password=Passw0rd123";

        try (Connection con = DriverManager.getConnection(connectionUrl);) {

            CallableStatement callableStatement = con.prepareCall("{call dbo.SwapCards(?,?)}");

            int errorCounter = 0;
            for (int count = 0; count < 1000; count++) {

                Random rn = new Random();
                int card1 = rn.nextInt(52 - 1 + 1) + 1;
                int card2 = rn.nextInt(52 - 1 + 1) + 1;

                try {
                    if (card1 != card2) {
                        callableStatement.setInt(1, card1);
                        callableStatement.setInt(2, card2);
                        callableStatement.execute();
                    }
                } catch (SQLException e1) {
                    errorCounter++;
                    System.out.println("We were unable to swap cards [" + e1.getMessage() + "]. Error Count ["
                            + Integer.toString(errorCounter) + "]");
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>

<section data-bs-version="5.1" class="content7 cid-ssQs5l3ADL" id="content7-ms">
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-10">
                <blockquote>
                <h5 class="mbr-section-title mbr-fonts-style mb-2 display-7"><strong>Full T-SQL code</strong></h5>

<pre class="language-clike"><code><!--         
DROP DATABASE Shuffle
GO

-- Create the DB
CREATE DATABASE Shuffle
GO

-- Allow snapshot isolation
ALTER DATABASE Shuffle
SET ALLOW_SNAPSHOT_ISOLATION ON
GO

-- Enable accelerated database recovery
ALTER DATABASE Shuffle
SET ACCELERATED_DATABASE_RECOVERY = ON;
GO

-- Use Shuffle DB
USE Shuffle
GO

-- Create the Deck
CREATE TABLE Cards
(
    Card CHAR(5) PRIMARY KEY
)
GO

INSERT INTO Cards
VALUES
    ('Ace'),
    ('2'),
    ('3'),
    ('4'),
    ('5'),
    ('6'),
    ('7'),
    ('8'),
    ('9'),
    ('10'),
    ('Jack'),
    ('Queen'),
    ('King')
GO

CREATE TABLE Suits
(
    Suit CHAR(8) PRIMARY KEY
)
GO

INSERT INTO Suits
VALUES
    ('Clubs'),
    ('Diamonds'),
    ('Hearts'),
    ('Spades')
GO

SELECT Id = IDENTITY(INT, 1, 1),
    Suits.Suit,
    Cards.Card
INTO Deck
FROM Cards
CROSS JOIN Suits
GO

ALTER TABLE Deck ADD CONSTRAINT Deck_PK PRIMARY KEY (Id)
GO

-- User Defined Function 'PickACard'
CREATE FUNCTION PickACard (@RAND FLOAT)
RETURNS INT
AS
BEGIN
    RETURN (
			SELECT FLOOR(@RAND * (52 - 1 + 1)) + 1
			)
END
GO

-- Stored Procedure 'SwapCardsV1'
CREATE PROCEDURE SwapCardsV1
    @Card1 INT = 1,
    @Card2 INT = 52
AS
BEGIN
    
    BEGIN TRY
		BEGIN TRANSACTION

		SET NOCOUNT ON

		-- Store the first card's details
		SELECT *
        INTO #Temp
        FROM Deck
        WHERE Id = @Card1

		-- Move second card into first card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT d.Card,
            d.Suit
        FROM Deck d
        WHERE Id = @Card2
			) CardDetails
		WHERE Id = @Card1

		-- Move first card into second card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT Card,
            Suit
        FROM #temp
			) CardDetails
		WHERE Id = @Card2

		COMMIT TRANSACTION;
	END TRY

	BEGIN CATCH
		-- PRINT 'We were unable to make the swap rolling back [' + ERROR_MESSAGE() + '].';
		ROLLBACK TRANSACTION;
        THROW 51000, 'Unable to swap card.', 1; 
	END CATCH
END
GO

-- Stored Procedure 'SwapCards'
CREATE PROCEDURE SwapCards
    @Card1 INT = 1,
    @Card2 INT = 52
AS
BEGIN
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;

    BEGIN TRY
		BEGIN TRANSACTION

		SET NOCOUNT ON

		-- Store the first card's details
		SELECT *
        INTO #Temp
        FROM Deck
        WHERE Id = @Card1

		-- Move second card into first card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT d.Card,
            d.Suit
        FROM Deck d
        WHERE Id = @Card2
			) CardDetails
		WHERE Id = @Card1

		-- Move first card into second card's place
		UPDATE Deck
		SET Card = CardDetails.Card,
			Suit = CardDetails.Suit
		FROM (
			SELECT Card,
            Suit
        FROM #temp
			) CardDetails
		WHERE Id = @Card2

		COMMIT TRANSACTION;
	END TRY

	BEGIN CATCH
		-- PRINT 'We were unable to make the swap rolling back [' + ERROR_MESSAGE() + '].';
		ROLLBACK TRANSACTION;
        THROW 51000, 'Unable to swap card.', 1; 
	END CATCH
END
GO

-- Stored Procedure 'SwapCardsAtRandom'
CREATE PROCEDURE SwapCardsAtRandom
AS
BEGIN
    DECLARE @Rnd1 FLOAT

    SET @Rnd1 = RAND()

    DECLARE @Card1 INT

    SET @Card1 = (
			SELECT dbo.PickACard(@Rnd1)
			)

    DECLARE @Rnd2 FLOAT

    SET @Rnd2 = RAND()

    DECLARE @Card2 INT

    SET @Card2 = (
			SELECT dbo.PickACard(@Rnd2)
			)

    -- 'No need to swap a card with itself'
    IF @Card1 != @Card2
	BEGIN
        EXECUTE dbo.SwapCards @Card1,
			@Card2
    END -- IF @Card1 != @Card2
END -- CREATE PROCEDURE SwapCards
GO

-- Call SwapCardsAtRandom Multiple times
DECLARE @Counter INT
SET @Counter = 0
DECLARE @ErrorCounter INT
SET @ErrorCounter = 0
WHILE (@Counter < 1000)
BEGIN

    BEGIN TRY
		EXECUTE SwapCardsAtRandom
	END TRY

	BEGIN CATCH
		SET @ErrorCounter = @ErrorCounter+1
        PRINT 'We were unable to swap cards [' + ERROR_MESSAGE() +']. Error Count ['+LTRIM(STR(@ErrorCounter,10))+']'  
	END CATCH
    
    SET @Counter = @Counter + 1
END
GO

-- Review results
SELECT COUNT(*)
FROM Deck
GROUP BY Suit
GO

SELECT *
FROM Deck
ORDER BY Card,Suit
GO
--></code></pre>
                    

                    
</blockquote>
            </div>
        </div>
    </div>
</section>


<script src="assets/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/smoothscroll/smooth-scroll.js"></script>
  <script src="assets/ytplayer/index.js"></script>
  <script src="assets/dropdown/js/navbar-dropdown.js"></script>
  <script src="assets/theme/js/script.js"></script>
  
  <script src="prism.js"></script>
<script src="webcomponents/howtoTooltip.js"></script>
  
</body>
</html>